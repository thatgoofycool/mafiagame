
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia.io - Online Mafia Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e4e4e4;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 30px;
            text-align: center;
            background: linear-gradient(45deg, #e94560, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 600px;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            font-size: 1em;
            background: rgba(255,255,255,0.1);
            color: #e4e4e4;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #e94560;
            background: rgba(255,255,255,0.15);
        }

        input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #e94560, #ff6b6b);
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
        }

        button.secondary:hover {
            background: rgba(255,255,255,0.15);
            border-color: #e94560;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none !important;
        }

        .screen {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Lobby specific styles */
        #lobby-code {
            font-size: 2.5em;
            font-weight: bold;
            color: #e94560;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 5px;
            text-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
        }

        .player-list {
            width: 100%;
            margin: 20px 0;
        }

        .player-item {
            background: rgba(255,255,255,0.05);
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }

        .player-item:hover {
            background: rgba(255,255,255,0.08);
            border-left-color: #e94560;
        }

        .player-item.is-you {
            background: rgba(233, 69, 96, 0.1);
            border-left-color: #e94560;
        }

        .player-name {
            font-weight: 500;
        }

        .player-status {
            font-size: 0.9em;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .player-status.ready {
            background: #2ecc71;
            color: #000;
        }

        .player-status.not-ready {
            background: #e74c3c;
            color: #fff;
        }

        /* Role reveal */
        .role-reveal {
            text-align: center;
            padding: 40px;
        }

        .role-emoji {
            font-size: 6em;
            margin-bottom: 20px;
        }

        .role-name {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #e94560;
        }

        .role-description {
            font-size: 1.1em;
            color: rgba(255,255,255,0.7);
            max-width: 500px;
            line-height: 1.6;
        }

        /* Game phase */
        .phase-banner {
            background: linear-gradient(45deg, #e94560, #ff6b6b);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }

        .phase-banner h2 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .phase-timer {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* Vote buttons */
        .vote-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            width: 100%;
            margin: 20px 0;
        }

        .vote-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .vote-card:hover {
            background: rgba(255,255,255,0.1);
            border-color: #e94560;
        }

        .vote-card.selected {
            background: rgba(233, 69, 96, 0.2);
            border-color: #e94560;
        }

        .vote-card.you-voted {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
        }

        /* Chat */
        .chat-container {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            width: 100%;
            max-width: 600px;
            margin: 20px 0;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
        }

        .chat-message.you {
            background: rgba(233, 69, 96, 0.2);
        }

        .chat-message.mafia {
            background: rgba(233, 69, 96, 0.3);
            border: 1px solid #e94560;
        }

        .chat-sender {
            font-weight: 600;
            color: #e94560;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input-container input {
            margin-bottom: 0;
            flex: 1;
        }

        .chat-input-container button {
            width: auto;
            margin-bottom: 0;
            padding: 15px 25px;
        }

        /* Public lobbies */
        .lobby-list {
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
        }

        .lobby-item {
            background: rgba(255,255,255,0.05);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .lobby-item:hover {
            background: rgba(255,255,255,0.1);
            border-color: #e94560;
        }

        .lobby-info h3 {
            margin-bottom: 5px;
        }

        .lobby-info p {
            color: rgba(255,255,255,0.5);
            font-size: 0.9em;
        }

        .lobby-code {
            font-family: monospace;
            font-size: 1.3em;
            color: #e94560;
            font-weight: bold;
        }

        /* Game over */
        .game-over-screen {
            text-align: center;
            padding: 40px;
        }

        .winner-banner {
            font-size: 2.5em;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 15px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
        }

        .winner-banner.mafia {
            background: linear-gradient(45deg, #e94560, #c0392b);
        }

        .all-roles {
            text-align: left;
            margin: 30px 0;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
        }

        .role-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .role-entry:last-child {
            border-bottom: none;
        }

        /* Night action selector */
        .night-action-container {
            text-align: center;
            width: 100%;
        }

        .action-description {
            margin-bottom: 20px;
            font-size: 1.1em;
            color: rgba(255,255,255,0.8);
        }

        /* Status message */
        .status-message {
            text-align: center;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin: 20px 0;
            width: 100%;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .waiting {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }
            
            .card {
                padding: 20px;
            }
            
            .role-emoji {
                font-size: 4em;
            }
            
            .role-name {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ¦¹ Mafia.io</h1>

        <!-- Main Menu Screen -->
        <div id="menu-screen" class="screen">
            <div class="card">
                <h2>Enter Your Name</h2>
                <input type="text" id="nickname" placeholder="Your nickname..." maxlength="20">
                <button onclick="showLobbyOptions()">Continue</button>
            </div>
        </div>

        <!-- Lobby Options Screen -->
        <div id="lobby-options-screen" class="screen hidden">
            <div class="card">
                <h2>Create Lobby</h2>
                <input type="text" id="lobby-name" placeholder="Lobby name (optional)" maxlength="30">
                <input type="number" id="max-players" placeholder="Max players (5-12)" min="5" max="12" value="8">
                <button onclick="createLobby()">Create Lobby</button>
            </div>
            
            <div class="card">
                <h2>Join Lobby</h2>
                <input type="text" id="join-code" placeholder="Enter 4-character lobby code" maxlength="4" style="text-transform: uppercase;">
                <button class="secondary" onclick="joinLobby()">Join by Code</button>
            </div>

            <div class="card">
                <h2>Public Lobbies</h2>
                <div id="public-lobbies" class="lobby-list">
                    <p class="waiting">Loading public lobbies...</p>
                </div>
                <button class="secondary" onclick="fetchPublicLobbies()">Refresh</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="screen hidden">
            <div class="card">
                <div id="lobby-code"></div>
                <div id="lobby-name-display" style="text-align: center; margin-bottom: 15px; font-size: 1.2em;"></div>
                
                <div class="player-list" id="player-list">
                    <!-- Players will be added here -->
                </div>

                <button id="ready-btn" onclick="toggleReady()">Not Ready</button>
                <button id="start-game-btn" class="secondary hidden" onclick="startGame()">Start Game</button>
                <button class="secondary" onclick="leaveLobby()">Leave Lobby</button>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Type a message..." maxlength="200">
                    <button onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Role Reveal Screen -->
        <div id="role-reveal-screen" class="screen hidden">
            <div class="card role-reveal">
                <div class="role-emoji" id="role-emoji"></div>
                <div class="role-name" id="role-name"></div>
                <div class="role-description" id="role-description"></div>
                <div id="teammates" style="margin-top: 20px; color: #e94560;"></div>
                <button onclick="closeRoleReveal()" style="margin-top: 30px;">I Understand</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <div class="phase-banner">
                <h2 id="phase-name">Day Phase</h2>
                <div class="phase-timer" id="phase-timer">30s remaining</div>
            </div>

            <div class="status-message" id="game-status-message"></div>

            <!-- Night Action Selector -->
            <div id="night-action-container" class="card night-action-container hidden">
                <div class="action-description" id="action-description"></div>
                <div class="vote-grid" id="night-targets"></div>
                <button class="secondary hidden" id="confirm-action-btn" onclick="confirmNightAction()">Confirm Action</button>
            </div>

            <!-- Day Voting -->
            <div id="day-voting-container" class="card hidden">
                <h3>Vote to Eliminate</h3>
                <div class="vote-grid" id="vote-targets"></div>
                <div id="vote-status" style="text-align: center; margin-top: 15px;"></div>
            </div>

            <!-- Players Alive -->
            <div class="card">
                <h3>Players Alive</h3>
                <div class="player-list" id="alive-players"></div>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="game-chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="game-chat-input" placeholder="Type a message..." maxlength="200">
                    <button onclick="sendGameChatMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen hidden">
            <div class="card game-over-screen">
                <div class="winner-banner" id="winner-banner"></div>
                
                <div class="all-roles">
                    <h3>All Roles Revealed:</h3>
                    <div id="all-roles-list"></div>
                </div>

                <button onclick="backToMenu()">Back to Menu</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        
        let gameState = {
            nickname: '',
            lobbyId: null,
            isHost: false,
            isReady: false,
            role: null,
            teammates: [],
            selectedTarget: null,
            hasActed: false,
            hasVoted: false
        };

        const roles = {
            mafia: {
                name: 'Mafia',
                emoji: 'ðŸ¦¹',
                description: 'You are a member of the Mafia! Work with your fellow mafia to eliminate townspeople. Choose a victim each night.',
                team: 'mafia'
            },
            doctor: {
                name: 'Doctor',
                emoji: 'ðŸ’Š',
                description: 'You are the Doctor! Choose one player to protect each night. If the mafia targets them, they will survive.',
                team: 'town'
            },
            detective: {
                name: 'Detective',
                emoji: 'ðŸ”',
                description: 'You are the Detective! Each night, investigate one player to learn if they are Mafia or innocent.',
                team: 'town'
            },
            villager: {
                name: 'Villager',
                emoji: 'ðŸ‘¤',
                description: 'You are a Villager! Use your wits and voting power to identify and eliminate the Mafia before they take over the town.',
                team: 'town'
            }
        };

        // Socket event listeners
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        socket.on('error', (error) => {
            alert('Error: ' + error);
        });

        socket.on('lobbyCreated', (lobby) => {
            gameState.lobbyId = lobby.id;
            gameState.isHost = true;
            showScreen('lobby-screen');
            updateLobbyInfo(lobby);
        });

        socket.on('lobbyJoined', (lobby) => {
            gameState.lobbyId = lobby.id;
            gameState.isHost = false;
            showScreen('lobby-screen');
            updateLobbyInfo(lobby);
        });

        socket.on('lobbyUpdated', (lobby) => {
            if (gameState.lobbyId === lobby.id) {
                updateLobbyInfo(lobby);
            }
        });

        socket.on('playerLeft', (data) => {
            if (gameState.lobbyId === data.lobbyId) {
                addChatMessage('System', `${data.playerName} left the lobby`, false);
            }
        });

        socket.on('gameStarted', (data) => {
            gameState.role = data.role;
            gameState.teammates = data.teammates;
            showRoleReveal();
        });

        socket.on('phaseChanged', (phase) => {
            handlePhaseChange(phase);
        });

        socket.on('nightAction', (data) => {
            if (data.role === gameState.role) {
                const roleName = roles[data.role].name;
                addGameChatMessage('System', `As the ${roleName}, you targeted ${data.target}. ${data.result || ''}`, false);
            }
        });

        socket.on('playerEliminated', (playerName) => {
            addGameChatMessage('System', `${playerName} was eliminated!`, false);
        });

        socket.on('playerProtected', () => {
            addGameChatMessage('System', 'The Doctor saved someone last night!', false);
        });

        socket.on('voteUpdate', (data) => {
            updateVoteStatus(data);
        });

        socket.on('chatMessage', (data) => {
            addChatMessage(data.sender, data.message, data.sender === gameState.nickname);
        });

        socket.on('gameChatMessage', (data) => {
            addGameChatMessage(data.sender, data.message, data.sender === gameState.nickname, data.isMafia);
        });

        socket.on('gameOver', (data) => {
            showGameOver(data);
        });

        // UI Functions
        function showLobbyOptions() {
            const nickname = document.getElementById('nickname').value.trim();
            if (!nickname) {
                alert('Please enter a nickname!');
                return;
            }
            gameState.nickname = nickname;
            socket.emit('setNickname', nickname);
            showScreen('lobby-options-screen');
            fetchPublicLobbies();
        }

        async function createLobby() {
            const name = document.getElementById('lobby-name').value.trim() || gameState.nickname + "'s Lobby";
            const maxPlayers = parseInt(document.getElementById('max-players').value);
            
            if (maxPlayers < 5 || maxPlayers > 12) {
                alert('Max players must be between 5 and 12!');
                return;
            }

            const response = await fetch('/api/lobbies', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, maxPlayers, host: gameState.nickname })
            });

            if (!response.ok) {
                alert('Failed to create lobby!');
                return;
            }

            const lobby = await response.json();
            socket.emit('joinLobby', lobby.code);
        }

        async function joinLobby() {
            const code = document.getElementById('join-code').value.trim().toUpperCase();
            if (!code) {
                alert('Please enter a lobby code!');
                return;
            }

            const response = await fetch('/api/lobbies/join', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, player: gameState.nickname })
            });

            if (!response.ok) {
                alert('Failed to join lobby! Make sure the code is correct.');
                return;
            }

            const lobby = await response.json();
            socket.emit('joinLobby', code);
        }

        async function fetchPublicLobbies() {
            try {
                const response = await fetch('/api/lobbies');
                const lobbies = await response.json();
                displayPublicLobbies(lobbies);
            } catch (error) {
                console.error('Error fetching lobbies:', error);
                document.getElementById('public-lobbies').innerHTML = '<p>No public lobbies available</p>';
            }
        }

        function displayPublicLobbies(lobbies) {
            const container = document.getElementById('public-lobbies');
            
            if (!lobbies || lobbies.length === 0) {
                container.innerHTML = '<p>No public lobbies available</p>';
                return;
            }

            container.innerHTML = lobbies.map(lobby => `
                <div class="lobby-item" onclick="quickJoin('${lobby.code}')">
                    <div class="lobby-info">
                        <h3>${escapeHtml(lobby.name)}</h3>
                        <p>${lobby.players.length}/${lobby.maxPlayers} players</p>
                    </div>
                    <div class="lobby-code">${lobby.code}</div>
                </div>
            `).join('');
        }

        function quickJoin(code) {
            document.getElementById('join-code').value = code;
            joinLobby();
        }

        function updateLobbyInfo(lobby) {
            document.getElementById('lobby-code').textContent = `Code: ${lobby.code}`;
            document.getElementById('lobby-name-display').textContent = lobby.name;
            
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = lobby.players.map(player => `
                <div class="player-item ${player.name === gameState.nickname ? 'is-you' : ''}">
                    <span class="player-name">${escapeHtml(player.name)}</span>
                    <span class="player-status ${player.ready ? 'ready' : 'not-ready'}">
                        ${player.ready ? 'Ready' : 'Not Ready'}
                    </span>
                </div>
            `).join('');

            // Show/hide start button for host
            const startBtn = document.getElementById('start-game-btn');
            if (gameState.isHost && allPlayersReady(lobby)) {
                startBtn.classList.remove('hidden');
            } else {
                startBtn.classList.add('hidden');
            }
        }

        function allPlayersReady(lobby) {
            return lobby.players.length >= 3 && lobby.players.every(p => p.ready);
        }

        function toggleReady() {
            gameState.isReady = !gameState.isReady;
            const btn = document.getElementById('ready-btn');
            btn.textContent = gameState.isReady ? 'Not Ready' : 'Ready';
            socket.emit('toggleReady', gameState.lobbyId);
        }

        function startGame() {
            socket.emit('startGame', gameState.lobbyId);
        }

        function leaveLobby() {
            socket.emit('leaveLobby', gameState.lobbyId);
            gameState.lobbyId = null;
            gameState.isHost = false;
            gameState.isReady = false;
            showScreen('lobby-options-screen');
            fetchPublicLobbies();
        }

        function showRoleReveal() {
            const role = roles[gameState.role];
            document.getElementById('role-emoji').textContent = role.emoji;
            document.getElementById('role-name').textContent = role.name;
            document.getElementById('role-description').textContent = role.description;
            
            const teammatesDiv = document.getElementById('teammates');
            if (gameState.teammates.length > 0) {
                teammatesDiv.innerHTML = `<p>Your ${gameState.role === 'mafia' ? 'fellow mafia members' : 'teammates'}: ${gameState.teammates.map(t => escapeHtml(t)).join(', ')}</p>`;
            } else {
                teammatesDiv.innerHTML = '';
            }

            showScreen('role-reveal-screen');
        }

        function closeRoleReveal() {
            showScreen('game-screen');
            document.getElementById('game-chat-messages').innerHTML = '';
            addGameChatMessage('System', 'The game has begun!', false);
        }

        function handlePhaseChange(phase) {
            document.getElementById('phase-name').textContent = phase.name;
            
            const nightActionContainer = document.getElementById('night-action-container');
            const dayVotingContainer = document.getElementById('day-voting-container');
            const statusMessage = document.getElementById('game-status-message');
            
            nightActionContainer.classList.add('hidden');
            dayVotingContainer.classList.add('hidden');
            
            gameState.hasActed = false;
            gameState.hasVoted = false;

            if (phase.type === 'night') {
                if (gameState.role === 'mafia' || gameState.role === 'doctor' || gameState.role === 'detective') {
                    nightActionContainer.classList.remove('hidden');
                    showNightTargets(phase.alivePlayers);
                } else {
                    statusMessage.textContent = 'Night has fallen. The town sleeps...';
                }
            } else if (phase.type === 'day') {
                dayVotingContainer.classList.remove('hidden');
                showVoteTargets(phase.alivePlayers);
                statusMessage.textContent = 'Discuss and vote to eliminate a suspect!';
            }

            addGameChatMessage('System', `${phase.name} has begun!`, false);
        }

        function showNightTargets(players) {
            const actionDescription = document.getElementById('action-description');
            const targetsContainer = document.getElementById('night-targets');
            const confirmBtn = document.getElementById('confirm-action-btn');
            
            const roleInfo = {
                mafia: 'Choose a victim to eliminate tonight...',
                doctor: 'Choose a player to protect tonight...',
                detective: 'Choose a player to investigate...'
            };
            
            actionDescription.textContent = roleInfo[gameState.role];
            
            targetsContainer.innerHTML = players
                .filter(p => p !== gameState.nickname)
                .map(player => `
                    <div class="vote-card" data-player="${escapeHtml(player)}" onclick="selectNightTarget('${escapeHtml(player)}')">
                        ${escapeHtml(player)}
                    </div>
                `).join('');
            
            confirmBtn.classList.add('hidden');
        }

        function selectNightTarget(player) {
            gameState.selectedTarget = player;
            document.querySelectorAll('#night-targets .vote-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.player === player) {
                    card.classList.add('selected');
                }
            });
            document.getElementById('confirm-action-btn').classList.remove('hidden');
        }

        function confirmNightAction() {
            if (!gameState.selectedTarget) return;
            socket.emit('nightAction', {
                lobbyId: gameState.lobbyId,
                role: gameState.role,
                target: gameState.selectedTarget
            });
            gameState.hasActed = true;
            document.getElementById('night-action-container').classList.add('hidden');
            document.getElementById('game-status-message').textContent = `You targeted ${gameState.selectedTarget}. Waiting for others...`;
        }

        function showVoteTargets(players) {
            const targetsContainer = document.getElementById('vote-targets');
            
            targetsContainer.innerHTML = players
                .filter(p => p !== gameState.nickname)
                .map(player => `
                    <div class="vote-card" data-player="${escapeHtml(player)}" onclick="castVote('${escapeHtml(player)}')">
                        ${escapeHtml(player)}
                    </div>
                `).join('');
            
            document.getElementById('vote-status').textContent = 'Select a player to vote for elimination';
        }

        function castVote(player) {
            if (gameState.hasVoted) {
                alert('You have already voted!');
                return;
            }
            
            socket.emit('vote', {
                lobbyId: gameState.lobbyId,
                target: player
            });
            gameState.hasVoted = true;
            gameState.selectedTarget = player;
            
            document.querySelectorAll('#vote-targets .vote-card').forEach(card => {
                if (card.dataset.player === player) {
                    card.classList.add('you-voted');
                }
            });
            
            document.getElementById('vote-status').textContent = `You voted for ${player}. Waiting for others...`;
        }

        function updateVoteStatus(data) {
            const voteStatus = document.getElementById('vote-status');
            const totalVotes = Object.values(data.votes).flat().length;
            voteStatus.textContent = `Votes: ${totalVotes}/${data.totalPlayers}`;
            
            // Show vote counts
            Object.entries(data.votes).forEach(([player, voters]) => {
                const card = document.querySelector(`#vote-targets .vote-card[data-player="${player}"]`);
                if (card) {
                    card.innerHTML = `${escapeHtml(player)}<br><small>${voters.length} votes</small>`;
                }
            });
        }

        function showGameOver(data) {
            const banner = document.getElementById('winner-banner');
            banner.textContent = `${data.winner} Wins!`;
            banner.classList.toggle('mafia', data.winner === 'Mafia');
            
            const rolesList = document.getElementById('all-roles-list');
            rolesList.innerHTML = data.roles.map(r => `
                <div class="role-entry">
                    <span>${escapeHtml(r.name)}</span>
                    <span>${roles[r.role].emoji} ${roles[r.role].name}</span>
                </div>
            `).join('');
            
            showScreen('game-over-screen');
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            socket.emit('chatMessage', {
                lobbyId: gameState.lobbyId,
                message: message
            });
            input.value = '';
        }

        function sendGameChatMessage() {
            const input = document.getElementById('game-chat-input');
            const message = input.value.trim();
            if (!message) return;
            
            socket.emit('gameChatMessage', {
                lobbyId: gameState.lobbyId,
                message: message
            });
            input.value = '';
        }

        function addChatMessage(sender, message, isYou) {
            const container = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${isYou ? 'you' : ''}`;
            msgDiv.innerHTML = `<span class="chat-sender">${escapeHtml(sender)}:</span> ${escapeHtml(message)}`;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addGameChatMessage(sender, message, isYou, isMafia) {
            const container = document.getElementById('game-chat-messages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${isYou ? 'you' : ''} ${isMafia ? 'mafia' : ''}`;
            msgDiv.innerHTML = `<span class="chat-sender">${escapeHtml(sender)}:</span> ${escapeHtml(message)}`;
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        function backToMenu() {
            gameState.lobbyId = null;
            gameState.isHost = false;
            gameState.isReady = false;
            gameState.role = null;
            gameState.teammates = [];
            showScreen('lobby-options-screen');
            fetchPublicLobbies();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle Enter key for chat
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        document.getElementById('game-chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendGameChatMessage();
        });
    </script>
</body>
</html>
